<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Rotina e Finanças (JavaScript puro)</title>
  <style>
    :root{--accent:#5b8def;--bg:#f6f8fb;--card:#ffffff;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f172a}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:linear-gradient(180deg,#ffffff, #f2f6ff);padding:20px;border-right:1px solid rgba(15,23,42,0.04)}
    h1{font-size:16px;margin:0 0 12px}
    nav button{display:block;width:100%;padding:10px;border-radius:10px;border:0;background:transparent;text-align:left;margin-bottom:8px;cursor:pointer}
    nav button.active{background:rgba(91,141,239,0.12);font-weight:600}
    main{padding:22px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 1px 2px rgba(15,23,42,0.03)}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;background:#fff}
    .tasks-list{list-style:none;padding:0;margin:0}
    .tasks-list li{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eef4ff}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .flex{display:flex;gap:12px;align-items:center}
    .right{justify-self:end}
    .progress{height:12px;background:#eef4ff;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#2a6fe8);width:0%}
    footer{padding:16px;text-align:center;color:var(--muted)}
    @media(max-width:900px){.app{grid-template-columns:1fr}aside{display:none}}
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <h1>Sistema de Rotina & Finanças</h1>
      <div class="muted">Organize seu tempo e dinheiro - offline</div>
      <nav style="margin-top:18px">
        <button id="nav-dashboard" class="active">Dashboard</button>
        <button id="nav-rotina">Rotina (tarefas)</button>
        <button id="nav-financas">Finanças</button>
        <button id="nav-config">Configurações</button>
      </nav>
      <hr style="margin:16px 0;border:0;border-top:1px solid #ecf2ff" />
      <div class="small muted">Dicas rápidas:</div>
      <ul style="padding-left:18px;margin-top:8px">
        <li class="small">Use tarefas recorrentes para hábitos</li>
        <li class="small">Defina metas de poupança mensal</li>
        <li class="small">Exportar/importar salva sua configuração</li>
      </ul>
    </aside>
    <main>
      <!-- DASHBOARD -->
      <section id="page-dashboard">
        <div class="grid">
          <div class="card">
            <h3>Resumo Rápido</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
              <div>
                <div class="muted">Tarefas hoje</div>
                <div id="today-count" style="font-size:20px;font-weight:700">0</div>
              </div>
              <div>
                <div class="muted">Saldo atual</div>
                <div id="current-balance" style="font-size:20px;font-weight:700">R$ 0,00</div>
              </div>
            </div>
            <div style="margin-top:12px">
              <div class="muted">Progresso de poupança</div>
              <div class="progress" style="margin-top:8px"><i id="saving-bar"></i></div>
              <div id="saving-text" class="small muted" style="margin-top:8px">Meta não definida</div>
            </div>
          </div>

          <div class="card">
            <h3>Próximas tarefas</h3>
            <ul id="next-tasks" class="tasks-list" style="margin-top:8px"></ul>
          </div>

          <div class="card">
            <h3>Fluxo mensal (últimos 30 dias)</h3>
            <canvas id="mini-chart" width="400" height="120"></canvas>
            <div class="muted small" style="margin-top:8px">Receitas - Despesas = Saldo</div>
          </div>

          <div class="card">
            <h3>Atalhos</h3>
            <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
              <button class="btn" id="add-task-short">Nova tarefa</button>
              <button class="btn" id="add-expense-short">Novo gasto</button>
              <button class="btn" id="export-data">Exportar dados</button>
              <button class="btn" id="import-data">Importar dados</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ROTINA -->
      <section id="page-rotina" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>Adicionar tarefa</h3>
            <label>Título</label>
            <input id="task-title" placeholder="Tomar água, Exercício, Estudar" />
            <label>Descrição</label>
            <textarea id="task-desc" rows="2"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <label>Data</label>
                <input id="task-date" type="date" />
              </div>
              <div style="width:160px">
                <label>Repetir</label>
                <select id="task-repeat">
                  <option value="none">Não</option>
                  <option value="daily">Diariamente</option>
                  <option value="weekly">Semanalmente</option>
                  <option value="monthly">Mensalmente</option>
                </select>
              </div>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn" id="save-task">Salvar tarefa</button>
              <button class="btn" id="clear-task">Limpar</button>
            </div>
          </div>

          <div class="card">
            <h3>Lista de tarefas</h3>
            <div style="margin-top:6px">
              <label>Filtrar</label>
              <select id="filter-view">
                <option value="all">Todas</option>
                <option value="today">Hoje</option>
                <option value="week">Semana</option>
                <option value="month">Mês</option>
              </select>
            </div>
            <ul id="tasks-list" class="tasks-list" style="margin-top:12px"></ul>
          </div>
        </div>
      </section>

      <!-- FINANCAS -->
      <section id="page-financas" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>Registrar entrada/saída</h3>
            <label>Tipo</label>
            <select id="tx-type"><option value="income">Receita</option><option value="expense">Despesa</option></select>
            <label>Descrição</label>
            <input id="tx-desc" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <label>Valor (R$)</label>
                <input id="tx-value" type="number" step="0.01" />
              </div>
              <div style="width:160px">
                <label>Data</label>
                <input id="tx-date" type="date" />
              </div>
            </div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn" id="save-tx">Salvar</button>
              <button class="btn" id="clear-tx">Limpar</button>
            </div>
          </div>

          <div class="card">
            <h3>Controle</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <div style="flex:1">
                <label>Meta de poupança mensal (R$)</label>
                <input id="saving-goal" type="number" step="0.01" />
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn" id="save-goal">Salvar meta</button>
              </div>
            </div>
            <div style="margin-top:12px">
              <h4>Últimas transações</h4>
              <ul id="tx-list" class="tasks-list" style="margin-top:8px"></ul>
            </div>
          </div>
        </div>
      </section>

      <!-- CONFIG -->
      <section id="page-config" style="display:none">
        <div class="grid">
          <div class="card">
            <h3>Dados & Backup</h3>
            <p class="muted">Exportar e importar seus dados (JSON). Os dados ficam no seu navegador.</p>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="export-btn">Exportar JSON</button>
              <input id="import-file" type="file" accept="application/json" />
            </div>
            <div style="margin-top:8px">
              <button class="btn" id="reset-data">Resetar dados</button>
            </div>
          </div>

          <div class="card">
            <h3>Sobre</h3>
            <p class="muted">Este é um sistema simples construído apenas em JavaScript puro, HTML e CSS. Funciona offline no seu navegador (localStorage).</p>
            <p class="muted">Se quiser, posso customizar para sincronizar com Google Drive/OneDrive ou transformar em app.</p>
          </div>
        </div>
      </section>

      <footer>&copy; Sistema Rotina & Finanças</footer>
    </main>
  </div>

  <script>
    // --- STORAGE KEYS ---
    const KEY = 'sistema_routine_fin_v1'

    // --- STATE ---
    let state = {tasks:[], tx:[], savingGoal:0}

    // --- UTIL ---
    const qs=(s,el=document)=>el.querySelector(s)
    const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s))
    function formatBRL(v){return 'R$ '+Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}

    // --- INIT ---
    function load(){
      const raw = localStorage.getItem(KEY)
      if(raw){ try{ state = JSON.parse(raw) }catch(e){console.warn('load fail',e) }}
      renderAll()
    }
    function save(){ localStorage.setItem(KEY,JSON.stringify(state)) }

    // --- NAV ---
    qsa('nav button').forEach(btn=>btn.addEventListener('click',e=>{
      qsa('nav button').forEach(b=>b.classList.remove('active'))
      e.target.classList.add('active')
      showPage(e.target.id.replace('nav-',''))
    }))
    function showPage(name){
      ['dashboard','rotina','financas','config'].forEach(p=>{
        qs('#page-'+p).style.display = (p===name)?'block':'none'
      })
    }

    // --- TASKS ---
    function addTask(t){ state.tasks.push(t); save(); renderTasks(); renderDashboard() }
    function toggleTask(id){ const t = state.tasks.find(x=>x.id===id); if(t){ t.done=!t.done; save(); renderTasks(); renderDashboard() }}
    function deleteTask(id){ state.tasks = state.tasks.filter(x=>x.id!==id); save(); renderTasks(); renderDashboard() }

    // --- TRANSACTIONS ---
    function addTx(tx){ state.tx.push(tx); save(); renderTx(); renderDashboard(); drawMiniChart() }
    function deleteTx(id){ state.tx = state.tx.filter(x=>x.id!==id); save(); renderTx(); renderDashboard(); drawMiniChart() }

    // --- RENDERERS ---
    function renderTasks(){
      const list = qs('#tasks-list'); list.innerHTML=''
      const filter = qs('#filter-view').value
      const now = new Date();
      state.tasks.sort((a,b)=> (a.date||'').localeCompare(b.date||''))
      state.tasks.forEach(t=>{
        if(filter==='today'){ const d = new Date(t.date||now.toISOString().slice(0,10)); if(d.toDateString()!==now.toDateString()) return }
        if(filter==='week'){ const d = new Date(t.date||now.toISOString().slice(0,10)); const diff = Math.ceil((d-now)/86400000); if(diff<0||diff>7) return }
        if(filter==='month'){ const d = new Date(t.date||now.toISOString().slice(0,10)); if(d.getMonth()!==now.getMonth()) return }
        const li = document.createElement('li')
        li.innerHTML = `
          <div style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" ${t.done? 'checked' : ''} data-id="${t.id}" />
            <div>
              <div style="font-weight:600">${t.title}</div>
              <div class="muted small">${t.date? t.date+' • '+(t.repeat!=='none'? ('Repete: '+t.repeat) : '') : ''}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button data-del="${t.id}" class="small muted">Excluir</button>
          </div>`
        list.appendChild(li)
      })
      qsa('input[type=checkbox]', list).forEach(cb=>cb.addEventListener('change',e=>toggleTask(e.target.dataset.id)))
      qsa('button[data-del]', list).forEach(b=>b.addEventListener('click',e=>deleteTask(e.target.dataset.del)))
      qs('#today-count').innerText = state.tasks.filter(t=>{
        const today = new Date().toISOString().slice(0,10)
        return (t.date||today)===today && !t.done
      }).length
      renderNextTasks()
    }

    function renderNextTasks(){
      const el = qs('#next-tasks'); el.innerHTML=''
      const sorted = state.tasks.filter(t=>!t.done).slice().sort((a,b)=> (a.date||'9999') < (b.date||'9999') ? -1:1).slice(0,5)
      sorted.forEach(t=>{
        const li = document.createElement('li')
        li.innerHTML = `<div>${t.title}<div class="muted small">${t.date||'Sem data'}</div></div><div class="muted small">${t.repeat!=='none'?t.repeat:''}</div>`
        el.appendChild(li)
      })
    }

    function renderTx(){
      const el = qs('#tx-list'); el.innerHTML=''
      const last = state.tx.slice().sort((a,b)=>b.date.localeCompare(a.date)).slice(0,10)
      last.forEach(t=>{
        const li = document.createElement('li')
        li.innerHTML = `<div>
            <div style="font-weight:600">${t.desc}</div>
            <div class="muted small">${t.date}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${formatBRL(t.type==='expense'? -Math.abs(t.value):t.value)}</div>
            <button data-del="${t.id}" class="small muted">Excluir</button>
          </div>`
        el.appendChild(li)
      })
      qsa('button[data-del]', el).forEach(b=>b.addEventListener('click',e=>deleteTx(e.target.dataset.del)))

      // balance
      const balance = state.tx.reduce((s,t)=> s + (t.type==='income'? Number(t.value) : -Number(t.value)),0)
      qs('#current-balance').innerText = formatBRL(balance)
      // saving progress
      const goal = Number(state.savingGoal||0)
      if(goal>0){
        const savedThisMonth = state.tx.filter(t=>t.type==='income' || t.type==='expense');
        // crude: assume net positive counts towards saving
        const net = state.tx.reduce((s,t)=> s + (t.type==='income'? Number(t.value) : -Number(t.value)),0)
        const pct = Math.max(0, Math.min(100, Math.round((net/goal)*100)))
        qs('#saving-bar').style.width = pct + '%'
        qs('#saving-text').innerText = `${pct}% da meta de ${formatBRL(goal)}`
      } else {
        qs('#saving-bar').style.width = '0%'
        qs('#saving-text').innerText = 'Meta não definida'
      }
    }

    function renderDashboard(){
      renderTasks(); renderTx(); drawMiniChart()
    }

    // --- SIMPLE CHART ---
    function drawMiniChart(){
      const c = qs('#mini-chart'); const ctx = c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height)
      const days = 30; const now = new Date(); const series = Array(days).fill(0)
      state.tx.forEach(t=>{
        const d = new Date(t.date)
        if(!isNaN(d)){
          const diff = Math.floor((now - d)/(86400000))
          if(diff>=0 && diff<days){ series[days-1-diff] += (t.type==='income'? Number(t.value): -Number(t.value)) }
        }
      })
      // cumulative
      let cum=0; const cumArr = series.map(v=>cum+=v)
      const min = Math.min(...cumArr,0); const max = Math.max(...cumArr,1)
      // draw
      ctx.beginPath(); cumArr.forEach((v,i)=>{
        const x = (i/(days-1))*c.width; const y = c.height - ((v-min)/(max-min))*c.height
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y)
      });
      ctx.strokeStyle = '#5b8def'; ctx.lineWidth=2; ctx.stroke()
    }

    // --- EVENTS ---
    qs('#save-task').addEventListener('click',()=>{
      const t = { id: 't'+Date.now(), title: qs('#task-title').value.trim() || 'Sem título', desc: qs('#task-desc').value, date: qs('#task-date').value, repeat: qs('#task-repeat').value, done:false }
      addTask(t); qs('#task-title').value=''; qs('#task-desc').value=''; qs('#task-date').value=''; qs('#task-repeat').value='none'
    })
    qs('#clear-task').addEventListener('click',()=>{ qs('#task-title').value=''; qs('#task-desc').value=''; qs('#task-date').value=''; qs('#task-repeat').value='none' })
    qs('#filter-view').addEventListener('change',renderTasks)

    qs('#save-tx').addEventListener('click',()=>{
      const tx = { id:'x'+Date.now(), type: qs('#tx-type').value, desc: qs('#tx-desc').value || (qs('#tx-type').value==='expense' ? 'Despesa' : 'Receita'), value: Number(qs('#tx-value').value)||0, date: qs('#tx-date').value || new Date().toISOString().slice(0,10) }
      addTx(tx); qs('#tx-desc').value=''; qs('#tx-value').value=''; qs('#tx-date').value=''
    })
    qs('#clear-tx').addEventListener('click',()=>{ qs('#tx-desc').value=''; qs('#tx-value').value=''; qs('#tx-date').value='' })

    qs('#save-goal').addEventListener('click',()=>{ state.savingGoal = Number(qs('#saving-goal').value)||0; save(); renderTx(); alert('Meta salva') })

    // export/import
    qs('#export-btn').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='sistema-dados.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })
    qs('#import-file').addEventListener('change',e=>{
      const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{
        try{ const imported = JSON.parse(reader.result); state = imported; save(); renderAll(); alert('Importado com sucesso') }catch(err){ alert('Arquivo inválido') }}; reader.readAsText(f)
    })

    qs('#export-data').addEventListener('click',()=>qs('#export-btn').click())
    qs('#import-data').addEventListener('click',()=>qs('#import-file').click())

    qs('#reset-data').addEventListener('click',()=>{ if(confirm('Resetar todos os dados?')){ state={tasks:[],tx:[],savingGoal:0}; save(); renderAll() } })

    // quick add
    qs('#add-task-short').addEventListener('click',()=>{ showPage('rotina'); qs('#task-title').focus() })
    qs('#add-expense-short').addEventListener('click',()=>{ showPage('financas'); qs('#tx-desc').focus() })

    // render all
    function renderAll(){
      qs('#saving-goal').value = state.savingGoal || ''
      renderDashboard(); renderTasks(); renderTx();
    }

    // initial load
    load();
  </script>
</body>
</html>
